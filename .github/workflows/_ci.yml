# Reusable workflow for running tests
# Called by deploy-qa.yml and deploy-prod.yml

name: CI Tests

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner to use'
        type: string
        default: 'ubuntu-latest'
    outputs:
      tests_passed:
        description: 'Whether all tests passed'
        value: ${{ jobs.summary.outputs.passed }}

env:
  NODE_VERSION: 20

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci || npm ci || npm ci
      - name: API Tests
        run: cd api && npm run lint && npm run typecheck && npm test
      - name: UI Tests
        run: cd ui && npm run lint && npm run typecheck && npm test

  e2e-tests:
    name: E2E Tests
    runs-on: ${{ inputs.runner }}
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8889
      FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      FIREBASE_PROJECT_ID: demo-gsdta
      USE_TEST_AUTH: 'true'
      ALLOW_TEST_INVITES: '1'
      NODE_ENV: test
      NEXT_PUBLIC_AUTH_MODE: firebase
      NEXT_PUBLIC_USE_MSW: false
      NEXT_PUBLIC_FIREBASE_API_KEY: demo-key
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: localhost
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_FIREBASE_APP_ID: demo-app
      NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST: localhost:8889
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - run: npm install -g firebase-tools
      - run: npm ci
      - name: Install native binaries
        run: |
          cd ui
          if npm run ensure:native; then
            echo "✅ ensure:native succeeded"
          else
            npm install --no-save lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu
          fi
          [ -f "node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node" ] && \
            cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node node_modules/lightningcss/
          [ -f "node_modules/@tailwindcss/oxide-linux-x64-gnu/oxide.linux-x64-gnu.node" ] && \
            cp node_modules/@tailwindcss/oxide-linux-x64-gnu/oxide.linux-x64-gnu.node node_modules/@tailwindcss/oxide/
          rm -rf ../node_modules/canvas node_modules/canvas 2>/dev/null || true
      - name: Verify bindings
        run: cd ui && node -e "require('lightningcss')" && node -e "require('@tailwindcss/oxide')"
      - name: Start emulators
        run: |
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          # Wait for emulators to be ready (up to 60 seconds)
          for i in {1..60}; do
            if curl -s http://localhost:9099 >/dev/null 2>&1; then
              echo "✅ Emulators ready after ${i}s"
              break
            fi
            sleep 1
          done
      - run: npm run seed
      - name: API E2E (Cucumber)
        run: cd api && npm run test:e2e
      - name: Build UI for E2E
        run: cd ui && npm run build
      - name: UI E2E (Playwright)
        run: cd ui && npm run e2e:ci
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ui/playwright-report/

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]
    if: always()
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check test results
        id: check
        run: |
          if [ "${{ needs.unit-tests.result }}" = "success" ] && [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "✅ All tests passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "❌ Some tests failed"
            exit 1
          fi
