# Reusable UAT workflow
# Runs UAT tests against a live environment

name: UAT Tests

on:
  workflow_call:
    inputs:
      base_url:
        description: 'Base URL for UAT tests'
        type: string
        required: true
      tags:
        description: 'Cucumber tags to run (e.g., @smoke, @admin)'
        type: string
        default: 'not @skip and not @wip'
      runner:
        description: 'Runner to use'
        type: string
        default: 'ubuntu-latest'
    secrets:
      UAT_ADMIN_EMAIL:
        required: true
      UAT_ADMIN_PASSWORD:
        required: true
      UAT_TEACHER_EMAIL:
        required: true
      UAT_TEACHER_PASSWORD:
        required: true
      UAT_PARENT_EMAIL:
        required: true
      UAT_PARENT_PASSWORD:
        required: true
      QA_FIREBASE_API_KEY:
        required: true
    outputs:
      passed:
        description: 'Whether UAT tests passed'
        value: ${{ jobs.uat.outputs.passed }}

env:
  NODE_VERSION: 20

jobs:
  uat:
    name: Run UAT Tests
    runs-on: ${{ inputs.runner }}
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
    outputs:
      passed: ${{ steps.result.outputs.passed }}
    env:
      UAT_BASE_URL: ${{ inputs.base_url }}
      UAT_ADMIN_EMAIL: ${{ secrets.UAT_ADMIN_EMAIL }}
      UAT_ADMIN_PASSWORD: ${{ secrets.UAT_ADMIN_PASSWORD }}
      UAT_TEACHER_EMAIL: ${{ secrets.UAT_TEACHER_EMAIL }}
      UAT_TEACHER_PASSWORD: ${{ secrets.UAT_TEACHER_PASSWORD }}
      UAT_PARENT_EMAIL: ${{ secrets.UAT_PARENT_EMAIL }}
      UAT_PARENT_PASSWORD: ${{ secrets.UAT_PARENT_PASSWORD }}
      FIREBASE_API_KEY: ${{ secrets.QA_FIREBASE_API_KEY }}
      FIREBASE_AUTH_DOMAIN: gsdta-qa.firebaseapp.com
      FIREBASE_PROJECT_ID: gsdta-qa
      HEADLESS: 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Wait for environment to be ready
        run: |
          echo "Waiting for $UAT_BASE_URL to be ready..."
          for i in {1..20}; do
            if curl -sf "$UAT_BASE_URL/api/v1/health" > /dev/null 2>&1; then
              echo "✅ Environment is ready"
              exit 0
            fi
            echo "Attempt $i/20: Environment not ready, waiting 10s..."
            sleep 10
          done
          echo "❌ Environment not ready after 200 seconds"
          exit 1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: cd uat && npx playwright install chromium

      - name: Run UAT smoke tests
        id: smoke
        run: |
          cd uat
          if npm run test:smoke; then
            echo "smoke_passed=true" >> $GITHUB_OUTPUT
          else
            echo "smoke_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run full UAT suite
        id: full
        if: steps.smoke.outputs.smoke_passed == 'true'
        run: |
          cd uat
          set +e
          npm run test:ci -- --tags "${{ inputs.tags }}"
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -ne 0 ]; then
            echo "full_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "full_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Set result
        id: result
        if: always()
        run: |
          SMOKE="${{ steps.smoke.outputs.smoke_passed }}"
          FULL="${{ steps.full.outputs.full_passed }}"
          echo "Smoke passed: $SMOKE"
          echo "Full passed: $FULL"

          if [ "$SMOKE" = "true" ] && [ "$FULL" = "true" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "✅ UAT tests passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "❌ UAT tests failed (smoke=$SMOKE, full=$FULL)"
          fi

      - name: Upload UAT reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uat-reports-${{ github.run_id }}
          path: uat/reports/
          retention-days: 14
