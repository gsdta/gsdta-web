name: CI

on:
  push:
    branches: [ develop ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '**/*.mdx'
      - '**/*.txt'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
      GO_VERSION: '1.21'
    steps:
      - uses: actions/checkout@v4

      # Setup Node and Go with caching
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: api/go.sum

      # API: deps, lint, test, build
      - name: API - download deps
        working-directory: ./api
        run: go mod download

      - name: API - lint
        working-directory: ./api
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run

      - name: API - tests
        working-directory: ./api
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: API - build
        working-directory: ./api
        run: |
          VERSION=$(git describe --tags --always 2>/dev/null || echo dev)
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo none)
          BUILDTIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          PKG=github.com/gsdta/api
          LDFLAGS="-X ${PKG}/internal/version.Version=${VERSION} -X ${PKG}/internal/version.Commit=${COMMIT} -X ${PKG}/internal/version.BuildTime=${BUILDTIME}"
          go build -ldflags "${LDFLAGS}" -o bin/api ./cmd/api

      # UI: deps, lint, typecheck, unit tests, build
      - name: UI - install deps
        working-directory: ./ui
        run: npm ci

      - name: UI - lint
        working-directory: ./ui
        run: npm run lint

      - name: UI - typecheck
        working-directory: ./ui
        run: npm run typecheck

      - name: UI - tests
        working-directory: ./ui
        run: npm test -- --ci

      - name: UI - build (server output)
        working-directory: ./ui
        env:
          NEXT_OUTPUT: standalone
          BACKEND_BASE_URL: http://localhost:8080/v1
        run: npm run build
