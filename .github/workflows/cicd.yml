name: CI/CD

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - Power
      
      run_tests:
        description: 'Run tests? (lint, typecheck, unit, E2E - Cucumber + Playwright)'
        required: true
        default: true
        type: boolean
      
      deploy:
        description: 'Deploy to Cloud Run?'
        required: true
        default: false
        type: boolean
      
      image_tag:
        description: 'Image tag (leave empty for commit SHA)'
        required: false
        default: ''

env:
  NODE_VERSION: 20
  GCP_PROJECT_ID: playground-personal-474821
  GAR_LOCATION: us-central1
  GAR_REPO: web-apps
  SERVICE_NAME: gsdta-web

jobs:
  # =================================================================
  # STAGE 1: Build & Test
  # =================================================================
  build-and-test:
    name: Build & Test
    runs-on: ${{ inputs.runner }}
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8889
      FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_AUTH_MODE: firebase
      NEXT_PUBLIC_USE_MSW: false
      NEXT_PUBLIC_FIREBASE_API_KEY: demo-key
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: localhost
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_FIREBASE_APP_ID: demo-app
      NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST: localhost:8889
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Java (for Firebase Emulators)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install platform-specific binaries for UI
        run: |
          cd ui
          npm run ensure:native
          # Remove canvas which causes issues in Playwright container
          rm -rf ../node_modules/canvas node_modules/canvas 2>/dev/null || true
          echo "âœ… Native binaries installed"
      
      - name: Verify native bindings
        run: |
          cd ui
          node -e "try { require('lightningcss'); console.log('âœ… lightningcss loaded'); } catch(e) { console.error('âŒ lightningcss failed:', e.message); process.exit(1); }"
          node -e "try { require('@tailwindcss/oxide'); console.log('âœ… @tailwindcss/oxide loaded'); } catch(e) { console.error('âŒ @tailwindcss/oxide failed:', e.message); process.exit(1); }"
      
      # ------------------------
      # Tests (if enabled)
      # ------------------------
      - name: Start Firebase Emulators
        if: ${{ inputs.run_tests }}
        run: |
          echo "ğŸ”¥ Starting Firebase Emulators..."
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          sleep 10
          echo "âœ… Emulators started"
      
      - name: Seed test data
        if: ${{ inputs.run_tests }}
        run: |
          echo "ğŸŒ± Seeding test data..."
          npm run seed
          echo "âœ… Test data seeded"
      
      - name: API Tests (Lint, Typecheck, Unit, E2E)
        if: ${{ inputs.run_tests }}
        run: |
          echo "â–¶ï¸  API: Lint, typecheck, unit tests, E2E (Cucumber)"
          cd api
          npm run lint
          npm run typecheck
          npm test
          npm run test:e2e
          echo "âœ… API tests passed"
      
      - name: UI Tests (Lint, Typecheck, Unit, E2E)
        if: ${{ inputs.run_tests }}
        run: |
          echo "â–¶ï¸  UI: Lint, typecheck, unit tests, E2E (Playwright)"
          cd ui
          npm run lint
          npm run typecheck
          npm test
          
          # Build API for UI E2E tests
          cd ../api && npm run build:test
          
          # Run Playwright E2E tests
          cd ../ui && npm run e2e:ci
          
          echo "âœ… UI tests passed"
      
      - name: Upload Playwright Report
        if: ${{ always() && inputs.run_tests }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ui/playwright-report/
          retention-days: 7
      
      - name: Tests summary
        if: ${{ inputs.run_tests }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ API: Lint, typecheck, unit, E2E (Cucumber)"
          echo "âœ“ UI: Lint, typecheck, unit, E2E (Playwright)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ------------------------
      # Build Docker Image
      # ------------------------
      - name: Install Docker (in Playwright container)
        run: |
          apt-get update
          apt-get install -y ca-certificates curl
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          chmod a+r /etc/apt/keyrings/docker.asc
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          apt-get update
          apt-get install -y docker-ce docker-ce-cli containerd.io
      
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet
      
      - name: Compute image metadata
        id: meta
        run: |
          TAG="${{ inputs.image_tag }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_SHA::7}"
          fi
          
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.SERVICE_NAME }}:${TAG}"
          
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸  Image tag: $TAG"
          echo "ğŸ“¦ Image URI: $IMAGE_URI"
      
      - name: Fetch Firebase secrets
        id: secrets
        run: |
          echo "Fetching Firebase secrets from GCP Secret Manager..."
          
          API_KEY=$(gcloud secrets versions access latest --secret=FIREBASE_API_KEY --project=${{ env.GCP_PROJECT_ID }})
          AUTH_DOMAIN=$(gcloud secrets versions access latest --secret=FIREBASE_AUTH_DOMAIN --project=${{ env.GCP_PROJECT_ID }})
          PROJECT_ID=$(gcloud secrets versions access latest --secret=FIREBASE_PROJECT_ID --project=${{ env.GCP_PROJECT_ID }})
          APP_ID=$(gcloud secrets versions access latest --secret=FIREBASE_APP_ID --project=${{ env.GCP_PROJECT_ID }})
          
          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "auth_domain=$AUTH_DOMAIN" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          
          echo "âœ… Firebase secrets fetched"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image_uri }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.tag }}
            COMMIT=${{ github.sha }}
            BUILDTIME=${{ github.event.head_commit.timestamp }}
            NEXT_PUBLIC_AUTH_MODE=firebase
            NEXT_PUBLIC_API_BASE_URL=/api
            NEXT_PUBLIC_USE_MSW=false
            NEXT_PUBLIC_FIREBASE_API_KEY=${{ steps.secrets.outputs.api_key }}
            NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ steps.secrets.outputs.auth_domain }}
            NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ steps.secrets.outputs.project_id }}
            NEXT_PUBLIC_FIREBASE_APP_ID=${{ steps.secrets.outputs.app_id }}
      
      - name: Build summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Build complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image: ${{ steps.meta.outputs.image_uri }}"
          echo "ğŸ·ï¸  Tag: ${{ steps.meta.outputs.tag }}"
          echo "ğŸ”¨ Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # =================================================================
  # STAGE 2: Deploy
  # =================================================================
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-test
    if: ${{ inputs.deploy }}
    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Deploy to Cloud Run
        run: |
          echo "ğŸš€ Deploying to Cloud Run..."
          
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.build-and-test.outputs.image_uri }} \
            --region ${{ env.GAR_LOCATION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 3000 \
            --set-env-vars "NEXT_TELEMETRY_DISABLED=1,NODE_ENV=production,NEXT_PUBLIC_API_BASE_URL=/api,GOOGLE_CLOUD_PROJECT=${{ env.GCP_PROJECT_ID }},NEXT_PUBLIC_AUTH_MODE=firebase,NEXT_PUBLIC_USE_MSW=false" \
            --set-secrets "NEXT_PUBLIC_FIREBASE_API_KEY=FIREBASE_API_KEY:latest,NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=FIREBASE_AUTH_DOMAIN:latest,NEXT_PUBLIC_FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest,NEXT_PUBLIC_FIREBASE_APP_ID=FIREBASE_APP_ID:latest"
          
          echo "âœ… Deployment complete"
      
      - name: Get service URL
        id: service
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GAR_LOCATION }} \
            --project ${{ env.GCP_PROJECT_ID }} \
            --format 'value(status.url)')
          
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Service URL: $SERVICE_URL"
      
      - name: Health check
        run: |
          echo "â³ Waiting for service to stabilize..."
          sleep 15
          
          echo "ğŸ¥ Running health check..."
          curl -f ${{ steps.service.outputs.url }}/api/v1/health || exit 1
          
          echo "âœ… Health check passed"
      
      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment successful"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Service: ${{ steps.service.outputs.url }}"
          echo "ğŸ“¦ Image: ${{ needs.build-and-test.outputs.image_uri }}"
          echo "ğŸ¥ Health: OK"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
