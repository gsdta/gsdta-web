# Manual Deployment
# Triggered by: workflow_dispatch (manual trigger)

name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - qa
          - production
      
      run_tests:
        description: 'Run tests before deploy?'
        required: true
        default: true
        type: boolean
      
      runner:
        description: 'Runner to use'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - Power
      
      image_tag:
        description: 'Image tag (leave empty for commit SHA)'
        required: false
        default: ''

jobs:
  # Step 1: Run tests (optional)
  tests:
    name: Run Tests
    if: ${{ inputs.run_tests }}
    uses: ./.github/workflows/_ci.yml
    with:
      runner: ${{ inputs.runner }}

  # Step 2: Deploy to Production
  deploy-prod:
    name: Deploy to Production
    needs: [tests]
    if: |
      inputs.environment == 'production' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    uses: ./.github/workflows/_build-deploy.yml
    with:
      environment: production
      service_name: gsdta-web
      site_url: https://app.gsdta.com
      runner: ${{ inputs.runner }}
      image_tag: ${{ inputs.image_tag }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      SECRETS_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      FIREBASE_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

  # Step 2: Deploy to QA
  deploy-qa:
    name: Deploy to QA
    needs: [tests]
    if: |
      inputs.environment == 'qa' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    uses: ./.github/workflows/_build-deploy.yml
    with:
      environment: qa
      service_name: gsdta-web-qa
      site_url: https://app.qa.gsdta.com
      runner: ${{ inputs.runner }}
      image_tag: ${{ inputs.image_tag }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_QA }}
      SECRETS_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_QA }}
      FIREBASE_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_QA }}
