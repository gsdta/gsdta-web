# QA Environment Deployment with UAT
# Triggered by: push to develop branch
# Flow: Tests + Build (parallel) -> Deploy to QA -> UAT Tests -> Merge to main

name: Deploy to QA with UAT

on:
  push:
    branches: [develop]

concurrency:
  group: deploy-qa-uat
  cancel-in-progress: true

env:
  NODE_VERSION: 20
  UAT_BASE_URL: https://app.qa.gsdta.com

jobs:
  # Step 1a: Run unit and E2E tests (emulator-based)
  tests:
    name: Run Tests
    uses: ./.github/workflows/_ci.yml
    with:
      runner: ubuntu-latest

  # Step 1b: Build Docker image (runs in parallel with tests)
  build:
    name: Build Image
    uses: ./.github/workflows/_build.yml
    with:
      environment: qa
      gcp_project_id: playground-personal-474821
      secrets_project_id: gsdta-qa
      site_url: https://app.qa.gsdta.com
      runner: ubuntu-latest
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

  # Step 2: Deploy to QA (only if tests pass, uses pre-built image)
  deploy:
    name: Deploy to QA
    needs: [tests, build]
    if: ${{ !failure() && !cancelled() }}
    uses: ./.github/workflows/_deploy.yml
    with:
      environment: qa
      service_name: gsdta-web-qa
      site_url: https://app.qa.gsdta.com
      firebase_project_id: gsdta-qa
      image_uri: ${{ needs.build.outputs.image_uri }}
      runner: ubuntu-latest
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

  # Step 3: Run UAT tests against live QA environment
  uat-tests:
    name: UAT Tests
    needs: [deploy]
    uses: ./.github/workflows/_uat.yml
    with:
      base_url: https://app.qa.gsdta.com
      tags: 'not @skip and not @wip and not @manual'
      runner: ubuntu-latest
    secrets:
      UAT_ADMIN_EMAIL: ${{ secrets.UAT_ADMIN_EMAIL }}
      UAT_ADMIN_PASSWORD: ${{ secrets.UAT_ADMIN_PASSWORD }}
      UAT_TEACHER_EMAIL: ${{ secrets.UAT_TEACHER_EMAIL }}
      UAT_TEACHER_PASSWORD: ${{ secrets.UAT_TEACHER_PASSWORD }}
      UAT_PARENT_EMAIL: ${{ secrets.UAT_PARENT_EMAIL }}
      UAT_PARENT_PASSWORD: ${{ secrets.UAT_PARENT_PASSWORD }}
      QA_FIREBASE_API_KEY: ${{ secrets.QA_FIREBASE_API_KEY }}

  # Step 4: Create PR and merge to main
  merge-to-main:
    name: Merge to Main
    needs: [uat-tests]
    if: needs.uat-tests.outputs.passed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use PAT to trigger deploy-prod workflow after merge
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if PR already exists
        id: check-pr
        run: |
          PR_EXISTS=$(gh pr list --head develop --base main --state open --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Create PR to main
        id: create-pr
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          PR_URL=$(gh pr create \
            --title "chore: Auto-merge develop to main after UAT" \
            --body "$(cat <<'EOF'
          ## Summary

          Automated PR created after successful UAT tests on QA environment.

          ### UAT Results
          - **Environment**: https://app.qa.gsdta.com
          - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - **Commit**: ${{ github.sha }}

          ### Changes
          All changes from develop branch that passed:
          1. ‚úÖ Unit tests
          2. ‚úÖ E2E tests (emulator-based)
          3. ‚úÖ QA deployment
          4. ‚úÖ UAT tests (against live QA)

          ---

          ü§ñ Auto-generated by UAT workflow
          EOF
          )" \
            --head develop \
            --base main)

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # Extract PR number
          PR_NUMBER=$(echo $PR_URL | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Get existing PR number
        id: get-pr
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          PR_NUMBER=$(gh pr list --head develop --base main --state open --json number --jq '.[0].number')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Merge PR
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number || steps.get-pr.outputs.pr_number }}"

          echo "Merging PR #$PR_NUMBER..."
          gh pr merge $PR_NUMBER --squash --delete-branch=false

          echo "‚úÖ PR #$PR_NUMBER merged to main"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

  # Step 5: Notify on failure
  notify-failure:
    name: Notify on Failure
    needs: [tests, build, deploy, uat-tests]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Log failure
        run: |
          echo "‚ùå Pipeline failed!"
          echo "Tests passed: ${{ needs.tests.outputs.tests_passed }}"
          echo "Build succeeded: ${{ needs.build.result }}"
          echo "Deploy succeeded: ${{ needs.deploy.result }}"
          echo "UAT passed: ${{ needs.uat-tests.outputs.passed }}"
          echo ""
          echo "Review the workflow run at:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
