name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_deploy:
        description: 'Actually deploy to Cloud Run'
        required: false
        default: 'true'
      image_tag:
        description: 'Custom image tag (defaults to commit SHA)'
        required: false
        default: ''

env:
  NODE_VERSION: 20
  GCP_PROJECT_ID: YOUR_PROJECT_ID
  GAR_LOCATION: us-central1
  GAR_REPO: web-apps
  SERVICE_NAME: gsdta-web

jobs:
  api:
    name: API - Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: E2E (Cucumber)
        run: npm run test:e2e

  ui:
    name: UI - Build & Test
    runs-on: ubuntu-latest
    needs: api
    container: mcr.microsoft.com/playwright:v1.56.1-jammy
    defaults:
      run:
        working-directory: ui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Unit tests
        run: npm test --if-present

      - name: E2E (Playwright)
        run: npm run e2e:ci

  docker:
    name: Build & Push Docker image
    runs-on: ubuntu-latest
    needs: ui
    permissions:
      contents: read
      id-token: write
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Compute metadata
        id: meta
        run: |
          COMMIT=${GITHUB_SHA::7}
          VERSION=$(git describe --tags --always || echo dev)
          BUILDTIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then TAG='${{ github.event.inputs.image_tag }}'; else TAG=""; fi
          if [ -z "$TAG" ]; then TAG=$COMMIT; fi
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "buildtime=$BUILDTIME" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "image_uri=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.SERVICE_NAME }}:$TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fetch Firebase secrets
        id: firebase-secrets
        run: |
          echo "api_key=$(gcloud secrets versions access latest --secret=FIREBASE_API_KEY --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "auth_domain=$(gcloud secrets versions access latest --secret=FIREBASE_AUTH_DOMAIN --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "project_id=$(gcloud secrets versions access latest --secret=FIREBASE_PROJECT_ID --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "app_id=$(gcloud secrets versions access latest --secret=FIREBASE_APP_ID --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT

      - name: Build image
        run: |
          docker build \
            --build-arg VERSION=${{ steps.meta.outputs.version }} \
            --build-arg COMMIT=${{ steps.meta.outputs.commit }} \
            --build-arg BUILDTIME=${{ steps.meta.outputs.buildtime }} \
            --build-arg NEXT_PUBLIC_AUTH_MODE=firebase \
            --build-arg NEXT_PUBLIC_API_BASE_URL=/api \
            --build-arg NEXT_PUBLIC_USE_MSW=false \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY=${{ steps.firebase-secrets.outputs.api_key }} \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ steps.firebase-secrets.outputs.auth_domain }} \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ steps.firebase-secrets.outputs.project_id }} \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID=${{ steps.firebase-secrets.outputs.app_id }} \
            -t ${{ steps.meta.outputs.image_uri }} .

      - name: Push image
        if: ${{ github.event_name == 'push' || github.event.inputs.run_deploy == 'true' }}
        run: docker push ${{ steps.meta.outputs.image_uri }}

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: docker
    if: ${{ github.event_name == 'push' || github.event.inputs.run_deploy == 'true' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.docker.outputs.image_uri }} \
            --region ${{ env.GAR_LOCATION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 3000 \
            --set-env-vars NEXT_TELEMETRY_DISABLED=1,NODE_ENV=production,NEXT_PUBLIC_AUTH_MODE=firebase,NEXT_PUBLIC_API_BASE_URL=/api,GOOGLE_CLOUD_PROJECT=${{ env.GCP_PROJECT_ID }},NEXT_PUBLIC_USE_MSW=false,USE_GO_API=false \
            --set-secrets NEXT_PUBLIC_FIREBASE_API_KEY=FIREBASE_API_KEY:latest,NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=FIREBASE_AUTH_DOMAIN:latest,NEXT_PUBLIC_FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest,NEXT_PUBLIC_FIREBASE_APP_ID=FIREBASE_APP_ID:latest
