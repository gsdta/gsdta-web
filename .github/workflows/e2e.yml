name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - Power

env:
  NODE_VERSION: 20

jobs:
  ui-e2e:
    name: UI E2E Tests (Playwright)
    runs-on: ${{ inputs.runner }}
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8889
      FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_AUTH_MODE: firebase
      NEXT_PUBLIC_USE_MSW: false
      NEXT_PUBLIC_FIREBASE_API_KEY: demo-key
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: localhost
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_FIREBASE_APP_ID: demo-app
      NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST: localhost:8889
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup Java (for Firebase Emulators)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install platform-specific binaries for UI
        run: |
          cd ui
          # Install native binaries for Linux x64 gnu (Playwright container)
          npm install --no-save lightningcss-linux-x64-gnu@1.30.2
          npm install --no-save @tailwindcss/oxide-linux-x64-gnu@4.0.14
          
          # Copy the binary to where lightningcss expects it
          cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node \
             node_modules/lightningcss/lightningcss.linux-x64-gnu.node
          
          # Copy oxide binary to where tailwindcss expects it
          cp node_modules/@tailwindcss/oxide-linux-x64-gnu/oxide.linux-x64-gnu.node \
             node_modules/@tailwindcss/oxide/oxide.linux-x64-gnu.node
          
          # Remove canvas (causes issues in Playwright container)
          rm -rf ../node_modules/canvas node_modules/canvas 2>/dev/null || true
          echo "âœ… Native binaries installed"
      
      - name: Verify native bindings
        run: |
          cd ui
          node -e "require('lightningcss'); console.log('âœ… lightningcss loaded')"
          node -e "require('@tailwindcss/oxide'); console.log('âœ… @tailwindcss/oxide loaded')"
      
      - name: Start Firebase Emulators
        run: |
          echo "ðŸ”¥ Starting Firebase Emulators..."
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          sleep 10
          echo "âœ… Emulators started"
      
      - name: Wait for emulators to be ready
        run: |
          echo "â³ Waiting for emulators..."
          for i in {1..30}; do
            if curl -s http://localhost:4445 > /dev/null 2>&1; then
              echo "âœ… Emulators are ready"
              exit 0
            fi
            echo -n "."
            sleep 1
          done
          echo "âŒ Emulators failed to start"
          exit 1
      
      - name: Seed test data
        run: |
          echo "ðŸŒ± Seeding test data..."
          npm run seed
          echo "âœ… Test data seeded"
      
      - name: Build API for E2E tests
        run: |
          echo "ðŸ”¨ Building API for E2E tests..."
          cd api
          npm run build:test
          echo "âœ… API built"
      
      - name: Run Playwright E2E tests
        run: |
          echo "ðŸŽ­ Running Playwright E2E tests..."
          cd ui
          npm run e2e:ci
          echo "âœ… E2E tests passed"
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ui/playwright-report/
          retention-days: 7
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: ui/test-results/
          retention-days: 7
      
      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š E2E Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "View detailed report:"
          echo "  Download 'playwright-report' artifact"
          echo "  Or check 'Actions > E2E Tests > Artifacts'"
          echo ""
