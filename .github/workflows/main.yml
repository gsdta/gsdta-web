name: Main Workflow

on:
  workflow_dispatch:
    inputs:
      # Runner configuration
      runner_os:
        description: 'Runner OS'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - 'ubuntu-latest'
          - 'ubuntu-latest-4-cores-linux'
          - 'ubuntu-22.04'
          - 'ubuntu-20.04'
          - 'windows-latest'
          - 'macos-latest'
          - 'macos-13'
          - 'self-hosted'
      
      # Stage selection
      run_emulator_tests:
        description: '1. Run Firebase emulator tests'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      
      run_api_tests:
        description: '2. Run API tests (lint, typecheck, e2e)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      
      run_ui_tests:
        description: '3. Run UI tests (lint, typecheck, e2e)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      
      run_docker_build:
        description: '4. Build and push Docker image'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      
      run_deploy:
        description: '5. Deploy to Cloud Run'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      
      # Build configuration
      image_tag:
        description: 'Docker image tag (defaults to commit SHA)'
        required: false
        default: ''
      
      auth_mode:
        description: 'Auth mode for UI build'
        required: false
        default: 'firebase'
        type: choice
        options:
          - 'firebase'
          - 'mock'

env:
  NODE_VERSION: 20
  GCP_PROJECT_ID: playground-personal-474821
  GAR_LOCATION: us-central1
  GAR_REPO: web-apps
  SERVICE_NAME: gsdta-web

jobs:
  emulator-tests:
    name: '1. Firebase Emulator Tests'
    runs-on: ${{ github.event.inputs.runner_os }}
    if: ${{ github.event.inputs.run_emulator_tests == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Cache Firebase Emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-${{ hashFiles('firebase.json') }}
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase Emulators (Background)
        run: |
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          sleep 10

      - name: Verify Emulators Running
        run: |
          curl -s http://localhost:4445 | grep -q "Emulator Suite" && echo "âœ… Emulator UI accessible"

  api:
    name: '2. API Tests'
    runs-on: ${{ github.event.inputs.runner_os }}
    needs: emulator-tests
    if: ${{ !cancelled() && github.event.inputs.run_api_tests == 'true' && (needs.emulator-tests.result == 'success' || needs.emulator-tests.result == 'skipped') }}
    defaults:
      run:
        working-directory: api
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8889
      FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      FIREBASE_PROJECT_ID: demo-gsdta
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Cache Firebase Emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-${{ hashFiles('firebase.json') }}
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Start Firebase Emulators
        run: |
          cd ..
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          sleep 10

      - name: Seed emulators
        run: |
          cd ../scripts && npm ci
          export FIRESTORE_EMULATOR_HOST=localhost:8889
          export FIREBASE_AUTH_EMULATOR_HOST=localhost:9099
          npm run seed

      - name: Install dependencies
        working-directory: .
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: E2E (Cucumber)
        run: npm run test:e2e

  ui:
    name: '3. UI Tests'
    runs-on: ${{ github.event.inputs.runner_os }}
    needs: api
    if: ${{ !cancelled() && github.event.inputs.run_ui_tests == 'true' && (needs.api.result == 'success' || needs.api.result == 'skipped') }}
    container: mcr.microsoft.com/playwright:v1.56.1-jammy
    defaults:
      run:
        working-directory: ui
    env:
      NEXT_PUBLIC_AUTH_MODE: firebase
      NEXT_PUBLIC_USE_MSW: false
      NEXT_PUBLIC_FIREBASE_API_KEY: demo-key
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: localhost
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_FIREBASE_APP_ID: demo-app
      NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST: localhost:8889
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firebase Emulators
        run: |
          cd ..
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          sleep 10

      - name: Seed emulators
        run: |
          cd ../scripts && npm ci
          export FIRESTORE_EMULATOR_HOST=localhost:8889
          export FIREBASE_AUTH_EMULATOR_HOST=localhost:9099
          npm run seed

      - name: Install dependencies
        working-directory: .
        run: |
          npm ci
          cd ui && npm run ensure:native
          cd ui && rm -rf node_modules/canvas

      - name: Verify native bindings
        run: |
          node -e "require('lightningcss'); console.log('âœ… lightningcss native binding loaded')"
          node -e "require('@tailwindcss/oxide'); console.log('âœ… tailwind css oxide native binding loaded')"

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Test
        run: npm test

      - name: Build API for e2e
        working-directory: ../api
        run: npm run build:test

      - name: E2E Tests
        run: npm run e2e:ci

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ui/playwright-report/
          retention-days: 7

  docker:
    name: '4. Build & Push Docker'
    runs-on: ${{ github.event.inputs.runner_os }}
    needs: ui
    if: ${{ !cancelled() && github.event.inputs.run_docker_build == 'true' && (needs.ui.result == 'success' || needs.ui.result == 'skipped') }}
    permissions:
      contents: read
      id-token: write
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
      auth_mode: ${{ steps.meta.outputs.auth_mode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Compute metadata
        id: meta
        run: |
          COMMIT=${GITHUB_SHA::7}
          VERSION=$(git describe --tags --always || echo dev)
          BUILDTIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TAG='${{ github.event.inputs.image_tag }}'
          if [ -z "$TAG" ]; then TAG=$COMMIT; fi
          AUTH_MODE='${{ github.event.inputs.auth_mode }}'
          if [ "$AUTH_MODE" != "firebase" ] && [ "$AUTH_MODE" != "mock" ]; then
            echo "Invalid auth_mode: $AUTH_MODE (expected 'firebase' or 'mock')" >&2
            exit 1
          fi
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "buildtime=$BUILDTIME" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "image_uri=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.SERVICE_NAME }}:$TAG" >> $GITHUB_OUTPUT
          echo "auth_mode=$AUTH_MODE" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Fetch Firebase secrets
        id: firebase-secrets
        if: ${{ steps.meta.outputs.auth_mode == 'firebase' }}
        run: |
          echo "api_key=$(gcloud secrets versions access latest --secret=FIREBASE_API_KEY --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "auth_domain=$(gcloud secrets versions access latest --secret=FIREBASE_AUTH_DOMAIN --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "project_id=$(gcloud secrets versions access latest --secret=FIREBASE_PROJECT_ID --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "app_id=$(gcloud secrets versions access latest --secret=FIREBASE_APP_ID --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT

      - name: Validate Firebase secrets
        if: ${{ steps.meta.outputs.auth_mode == 'firebase' }}
        run: |
          set -euo pipefail
          if [ -z "${{ steps.firebase-secrets.outputs.api_key }}" ] || \
             [ -z "${{ steps.firebase-secrets.outputs.auth_domain }}" ] || \
             [ -z "${{ steps.firebase-secrets.outputs.project_id }}" ] || \
             [ -z "${{ steps.firebase-secrets.outputs.app_id }}" ]; then
            echo "One or more Firebase secrets are empty. Ensure the GitHub SA has Secret Manager access and that secrets exist." >&2
            echo "Project: ${{ env.GCP_PROJECT_ID }}" >&2
            exit 1
          fi
          echo "Firebase secrets fetched (values masked in logs)."

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image_uri }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
            COMMIT=${{ steps.meta.outputs.commit }}
            BUILDTIME=${{ steps.meta.outputs.buildtime }}
            NEXT_PUBLIC_AUTH_MODE=${{ steps.meta.outputs.auth_mode }}
            NEXT_PUBLIC_API_BASE_URL=/api
            NEXT_PUBLIC_USE_MSW=false
            NEXT_PUBLIC_FIREBASE_API_KEY=${{ steps.meta.outputs.auth_mode == 'firebase' && steps.firebase-secrets.outputs.api_key || '' }}
            NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ steps.meta.outputs.auth_mode == 'firebase' && steps.firebase-secrets.outputs.auth_domain || '' }}
            NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ steps.meta.outputs.auth_mode == 'firebase' && steps.firebase-secrets.outputs.project_id || '' }}
            NEXT_PUBLIC_FIREBASE_APP_ID=${{ steps.meta.outputs.auth_mode == 'firebase' && steps.firebase-secrets.outputs.app_id || '' }}

  deploy:
    name: '5. Deploy to Cloud Run'
    runs-on: ${{ github.event.inputs.runner_os }}
    needs: docker
    if: ${{ !cancelled() && github.event.inputs.run_deploy == 'true' && (needs.docker.result == 'success' || needs.docker.result == 'skipped') }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.docker.outputs.image_uri }} \
            --region ${{ env.GAR_LOCATION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NEXT_PUBLIC_AUTH_MODE=${{ needs.docker.outputs.auth_mode }}" \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Get Service URL
        id: service
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.GAR_LOCATION }} \
            --project ${{ env.GCP_PROJECT_ID }} \
            --format 'value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployed to: $SERVICE_URL"

      - name: Health Check
        run: |
          sleep 10
          curl -f ${{ steps.service.outputs.url }}/api/v1/health || exit 1
          echo "âœ… Health check passed"
