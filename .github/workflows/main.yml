name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - Power
      
      run_unit_tests:
        description: 'Run unit tests? (lint, typecheck, unit)'
        required: true
        default: false
        type: boolean
      
      run_e2e_tests:
        description: 'Run E2E tests? (Playwright)'
        required: true
        default: false
        type: boolean
      
      build_image:
        description: 'Build & push Docker image?'
        required: true
        default: true
        type: boolean
      
      deploy:
        description: 'Deploy to Cloud Run?'
        required: true
        default: true
        type: boolean
      
      image_tag:
        description: 'Image tag (leave empty for commit SHA)'
        required: false
        default: ''

env:
  NODE_VERSION: 20
  GCP_PROJECT_ID: YOUR_PROJECT_ID
  GAR_LOCATION: us-central1
  GAR_REPO: web-apps
  SERVICE_NAME: gsdta-web

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ${{ inputs.runner }}
    if: ${{ inputs.run_unit_tests }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci || npm ci || npm ci
      - name: API Tests
        run: cd api && npm run lint && npm run typecheck && npm test
      - name: UI Tests
        run: cd ui && npm run lint && npm run typecheck && npm test

  e2e-tests:
    name: E2E Tests
    runs-on: ${{ inputs.runner }}
    if: ${{ inputs.run_e2e_tests }}
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8889
      FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      FIREBASE_PROJECT_ID: demo-gsdta
      USE_TEST_AUTH: 'true'
      ALLOW_TEST_INVITES: '1'
      NODE_ENV: test
      NEXT_PUBLIC_AUTH_MODE: firebase
      NEXT_PUBLIC_USE_MSW: false
      NEXT_PUBLIC_FIREBASE_API_KEY: demo-key
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: localhost
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: demo-gsdta
      NEXT_PUBLIC_FIREBASE_APP_ID: demo-app
      NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
      NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST: localhost:8889
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      - run: npm install -g firebase-tools
      - run: npm ci
      - name: Install native binaries
        run: |
          cd ui
          if npm run ensure:native; then
            echo "✅ ensure:native succeeded"
          else
            npm install --no-save lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu
          fi
          [ -f "node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node" ] && \
            cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node node_modules/lightningcss/
          [ -f "node_modules/@tailwindcss/oxide-linux-x64-gnu/oxide.linux-x64-gnu.node" ] && \
            cp node_modules/@tailwindcss/oxide-linux-x64-gnu/oxide.linux-x64-gnu.node node_modules/@tailwindcss/oxide/
          rm -rf ../node_modules/canvas node_modules/canvas 2>/dev/null || true
      - name: Verify bindings
        run: cd ui && node -e "require('lightningcss')" && node -e "require('@tailwindcss/oxide')"
      - name: Start emulators
        run: |
          firebase emulators:start --project demo-gsdta --only auth,firestore &
          # Wait for emulators to be ready (up to 60 seconds)
          for i in {1..60}; do
            if curl -s http://localhost:9099 >/dev/null 2>&1; then
              echo "✅ Emulators ready after ${i}s"
              break
            fi
            sleep 1
          done
      - run: npm run seed
      - name: API E2E (Cucumber)
        run: cd api && npm run test:e2e
      - name: Build UI for E2E
        run: cd ui && npm run build
      - name: UI E2E (Playwright)
        run: cd ui && npm run e2e:ci
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ui/playwright-report/

  build:
    name: Build Docker Image
    runs-on: ${{ inputs.runner }}
    if: ${{ inputs.build_image }}
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet
      - name: Compute metadata
        id: meta
        shell: bash
        run: |
          TAG="${{ inputs.image_tag }}"
          [ -z "$TAG" ] && TAG="${GITHUB_SHA::7}"
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO }}/${{ env.SERVICE_NAME }}:${TAG}"
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: Fetch secrets
        id: secrets
        run: |
          echo "api_key=$(gcloud secrets versions access latest --secret=FIREBASE_API_KEY --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "auth_domain=$(gcloud secrets versions access latest --secret=FIREBASE_AUTH_DOMAIN --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "project_id=$(gcloud secrets versions access latest --secret=FIREBASE_PROJECT_ID --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
          echo "app_id=$(gcloud secrets versions access latest --secret=FIREBASE_APP_ID --project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_OUTPUT
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.image_uri }}
          no-cache: true
          build-args: |
            VERSION=${{ steps.meta.outputs.tag }}
            COMMIT=${{ github.sha }}
            NEXT_PUBLIC_AUTH_MODE=firebase
            NEXT_PUBLIC_API_BASE_URL=/api
            NEXT_PUBLIC_USE_MSW=false
            NEXT_PUBLIC_FIREBASE_API_KEY=${{ steps.secrets.outputs.api_key }}
            NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ steps.secrets.outputs.auth_domain }}
            NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ steps.secrets.outputs.project_id }}
            NEXT_PUBLIC_FIREBASE_APP_ID=${{ steps.secrets.outputs.app_id }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ always() && inputs.deploy && needs.build.result == 'success' }}
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.build.outputs.image_uri }} \
            --region ${{ env.GAR_LOCATION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 3000 \
            --set-env-vars "NEXT_TELEMETRY_DISABLED=1,NODE_ENV=production,NEXT_PUBLIC_API_BASE_URL=/api,GOOGLE_CLOUD_PROJECT=${{ env.GCP_PROJECT_ID }},NEXT_PUBLIC_AUTH_MODE=firebase,NEXT_PUBLIC_USE_MSW=false" \
            --set-secrets "FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest,NEXT_PUBLIC_FIREBASE_API_KEY=FIREBASE_API_KEY:latest,NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=FIREBASE_AUTH_DOMAIN:latest,NEXT_PUBLIC_FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest,NEXT_PUBLIC_FIREBASE_APP_ID=FIREBASE_APP_ID:latest"
      - name: Health check
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.GAR_LOCATION }} --format 'value(status.url)')
          sleep 15
          curl -f $URL/api/v1/health
          echo "✅ Deployed: $URL"
