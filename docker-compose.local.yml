services:
  # Firebase Emulators
  firebase-emulators:
    image: andreysenov/firebase-tools:latest
    ports:
      - "4445:4445"  # Emulator UI
      - "9099:9099"  # Auth Emulator
      - "8889:8889"  # Firestore Emulator
    volumes:
      - ./firebase.json:/home/node/firebase.json:ro
      - ./persistence:/home/node/persistence:ro
      - firebase-data:/home/node/.firebase
    command: firebase emulators:start --project demo-gsdta --import=/home/node/.firebase --export-on-exit
    environment:
      - FIRESTORE_EMULATOR_HOST=0.0.0.0:8889
      - FIREBASE_AUTH_EMULATOR_HOST=0.0.0.0:9099
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4445 || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s

  # UI (Development)
  ui-dev:
    build:
      context: ./ui
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./ui:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_AUTH_MODE=firebase
      - NEXT_PUBLIC_USE_MSW=false
      - NEXT_PUBLIC_API_BASE_URL=/api
      - NEXT_PUBLIC_FIREBASE_API_KEY=demo-key
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=localhost
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=demo-gsdta
      - NEXT_PUBLIC_FIREBASE_APP_ID=demo-app
      - NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST=localhost:9099
      - NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST=localhost:8889
      - NEXT_PUBLIC_SKIP_EMAIL_VERIFICATION=true
      - API_PROXY_URL=http://api-dev:8080
    depends_on:
      firebase-emulators:
        condition: service_started
      api-dev:
        condition: service_started

  # API (Development)
  api-dev:
    build:
      context: ./api
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"
    volumes:
      - ./api:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - FIRESTORE_EMULATOR_HOST=firebase-emulators:8889
      - FIREBASE_AUTH_EMULATOR_HOST=firebase-emulators:9099
      - FIREBASE_PROJECT_ID=demo-gsdta
      - GCLOUD_PROJECT=demo-gsdta
    depends_on:
      firebase-emulators:
        condition: service_started

volumes:
  firebase-data:
