version: '3.8'

services:
  ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_USE_MSW: "false"
        NEXT_PUBLIC_API_BASE_URL: "/api"
        BACKEND_BASE_URL: "http://localhost:8080"
        VERSION: "${VERSION:-dev}"
        COMMIT: "${COMMIT:-none}"
        BUILDTIME: "${BUILDTIME:-unknown}"
    ports:
      - "3000:3000"
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_USE_MSW=false
      - NEXT_PUBLIC_API_BASE_URL=/api
      - BACKEND_BASE_URL=http://localhost:8080
      - API_PORT=8080
      # API configuration
      - APP_ENV=production
      - LOG_LEVEL=info
      - CORS_ALLOWED_ORIGINS=*
      - SEED_ON_START=false
      - MIGRATE_ON_START=false
      # Optional: DATABASE_URL for Postgres
      # - DATABASE_URL=postgres://user:pass@host:5432/gsdta?sslmode=disable
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"http=require('http');chk=(u,cb)=>{r=http.get(u,x=>cb(x.statusCode===200)).on('error',()=>cb(false));};chk('http://localhost:3000',ok=>{if(!ok)process.exit(1);chk('http://localhost:8080/healthz',ok2=>process.exit(ok2?0:1))});\" " ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Development: run Next dev server and Go API as separate containers
  api-dev:
    image: golang:1.21-alpine
    working_dir: /work/api
    volumes:
      - ./api:/work/api
    command: sh -c "apk add --no-cache git && go run ./cmd/api"
    environment:
      - APP_ENV=development
      - PORT=8080
      - LOG_LEVEL=debug
      - CORS_ALLOWED_ORIGINS=http://localhost:3001
      - SEED_ON_START=true
      - MIGRATE_ON_START=false
    expose:
      - "8080"
    profiles:
      - dev

  ui-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3000"
    volumes:
      - ./ui:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_USE_MSW=false
      - NEXT_PUBLIC_API_BASE_URL=/api
      - BACKEND_BASE_URL=http://api-dev:8080/v1
    depends_on:
      - api-dev
    profiles:
      - dev
