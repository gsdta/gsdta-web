rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }
    function isSuperAdmin() {
      return isSignedIn() && ('super_admin' in userDoc(request.auth.uid).data.roles) && userDoc(request.auth.uid).data.status == 'active';
    }
    function isAdmin() {
      // Admin check includes super_admin (role hierarchy)
      return isSignedIn() && (
        ('admin' in userDoc(request.auth.uid).data.roles) ||
        ('super_admin' in userDoc(request.auth.uid).data.roles)
      ) && userDoc(request.auth.uid).data.status == 'active';
    }

    // Users collection: users/{uid}
    match /users/{uid} {
      // Create: self on first login
      allow create: if isSignedIn() && request.auth.uid == uid;

      // Read single doc: self or admin
      allow get: if isSignedIn() && (request.auth.uid == uid || isAdmin());

      // List/query: admin only
      allow list: if isAdmin();

      // Update: self (restricted fields) or admin (full)
      allow update: if isSignedIn() && (
        isAdmin() || (
          request.auth.uid == uid &&
          // Prevent self from changing restricted fields
          !request.resource.data.diff(resource.data).changedKeys().hasAny(['roles', 'status', 'invitedBy'])
        )
      );

      // Delete: admin only
      allow delete: if isAdmin();
    }

    // Role invites: admin-only management
    match /roleInvites/{inviteId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // Hero content: public read, admin write
    match /heroContent/{contentId} {
      // Anyone can read active hero content
      allow get, list: if true;

      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Grades: public read (for class enrollment), admin write
    match /grades/{gradeId} {
      // Anyone can read grades
      allow get, list: if true;

      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Classes: public read (for enrollment), admin write
    match /classes/{classId} {
      // Anyone can read classes
      allow get, list: if true;

      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Students collection: teachers can read students in their classes
    match /students/{studentId} {
      // Read: admin, parent (own children), or teacher (assigned class)
      allow get: if isSignedIn() && (
        isAdmin() ||
        resource.data.parentId == request.auth.uid
        // Teacher access is handled at API level for class-based filtering
      );

      // List: admin only (teachers use API with class filter)
      allow list: if isAdmin();

      // Create/Update/Delete: admin only
      allow create, update, delete: if isAdmin();
    }

    // Admin promotions: super_admin only (track admin role changes)
    match /adminPromotions/{promotionId} {
      allow get, list: if isSuperAdmin();
      allow create: if isSuperAdmin();
      // No update or delete - these are audit records
    }

    // Attendance collection: teachers can manage attendance for their classes
    match /attendance/{recordId} {
      // Helper to check if user is a teacher
      function isTeacher() {
        return isSignedIn() &&
               'teacher' in userDoc(request.auth.uid).data.roles &&
               userDoc(request.auth.uid).data.status == 'active';
      }

      // Read: admin or teacher (API handles class-based filtering)
      allow get, list: if isSignedIn() && (isAdmin() || isTeacher());

      // Create: admin or teacher
      allow create: if isSignedIn() && (isAdmin() || isTeacher());

      // Update: admin or teacher (within edit window - validated at API level)
      allow update: if isSignedIn() && (isAdmin() || isTeacher());

      // Delete: admin only (soft delete preferred)
      allow delete: if isAdmin();
    }

    // Default deny for everything else
  }
}
