rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }
    function isAdmin() {
      return isSignedIn() && ('admin' in userDoc(request.auth.uid).data.roles) && userDoc(request.auth.uid).data.status == 'active';
    }

    // Users collection: users/{uid}
    match /users/{uid} {
      // Create: self on first login
      allow create: if isSignedIn() && request.auth.uid == uid;

      // Read single doc: self or admin
      allow get: if isSignedIn() && (request.auth.uid == uid || isAdmin());

      // List/query: admin only
      allow list: if isAdmin();

      // Update: self (restricted fields) or admin (full)
      allow update: if isSignedIn() && (
        isAdmin() || (
          request.auth.uid == uid &&
          // Prevent self from changing restricted fields
          !request.resource.data.diff(resource.data).changedKeys().hasAny(['roles', 'status', 'invitedBy'])
        )
      );

      // Delete: admin only
      allow delete: if isAdmin();
    }

    // Role invites: admin-only management
    match /roleInvites/{inviteId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // Hero content: public read, admin write
    match /heroContent/{contentId} {
      // Anyone can read active hero content
      allow get, list: if true;
      
      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Default deny for everything else
  }
}
