/*
  AUTO-GENERATED SCRIPT
  Reads thirukkural.json at repo root and generates:
    - src/data/thirukkural-data.ts (data array only)
    - src/data/thirukkural.ts (model/types + helpers importing the data)
*/

/* eslint-disable @typescript-eslint/no-require-imports */
const fs = require("fs");
const path = require("path");

function readJson(filePath) {
    const jsonStr = fs.readFileSync(filePath, "utf8");
    return JSON.parse(jsonStr);
}

function normalizeVerse(item) {
    const number = item.number ?? item.no ?? item.verse ?? 0;
    const kuralLines = item.kural || item.couplet || item.couplet_tamil || item.tamil || [];
    const kural = Array.isArray(kuralLines)
        ? kuralLines.join(" ").trim()
        : String(kuralLines || "").trim();

    const english_explanation = (item.meaning && (item.meaning.en || item.meaning.english))
        || item.en
        || item.english
        || item.translation
        || "";

    const theme = item.chapter || item.adhigaram || item.theme || item.chapter_name || "";

    const tamil_explanation = (item.meaning && (item.meaning.ta_mu_va || item.meaning.ta_salamon || item.meaning.ta || item.meaning.tamil))
        || item.ta_mu_va
        || item.ta_salamon
        || item.tamil_explanation
        || "";

    return {number, kural, english_explanation, theme, tamil_explanation};
}

function generateDataTs(verses) {
    const header = `// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by scripts/generate-thirukkural.js from thirukkural.json
// Data only. Model/types and helpers live in src/data/thirukkural.ts
`;

    const arrayLiteral = JSON.stringify(verses, null, 2);
    const exportBlock = `export const thirukkuralVerses = ${arrayLiteral};\n`;
    return header + "\n" + exportBlock;
}

function generateModelTs() {
    const header = `// AUTO-GENERATED FILE - SAFE TO EDIT, WILL BE OVERWRITTEN BY GENERATOR
// Model/types and helpers for Thirukkural; imports data from ./thirukkural-data
`;
    const body = `export interface ThirukkuralVerse {
  number: number;
  kural: string;
  english_explanation: string;
  theme: string;
  tamil_explanation: string;
}

import { thirukkuralVerses as rawThirukkuralData } from "./thirukkural-data";

export const thirukkuralVerses: ThirukkuralVerse[] = rawThirukkuralData as unknown as ThirukkuralVerse[];

export function getRandomThirukkural(): ThirukkuralVerse {
  const randomIndex = Math.floor(Math.random() * thirukkuralVerses.length);
  return thirukkuralVerses[randomIndex];
}

export function getThirukkuralByTheme(theme: string): ThirukkuralVerse[] {
  return thirukkuralVerses.filter((verse) => verse.theme === theme);
}
`;
    return header + "\n" + body;
}

function main() {
    const repoRoot = path.resolve(__dirname, "..");
    const jsonPath = path.join(repoRoot, "thirukkural.json");
    const outDataPath = path.join(repoRoot, "src", "data", "thirukkural-data.ts");
    const outModelPath = path.join(repoRoot, "src", "data", "thirukkural.ts");

    if (!fs.existsSync(jsonPath)) {
        console.error(`Could not find thirukkural.json at ${jsonPath}`);
        process.exit(1);
    }

    console.log("Reading:", jsonPath);
    const json = readJson(jsonPath);

    const items = Array.isArray(json)
        ? json
        : Array.isArray(json.kurals)
            ? json.kurals
            : Array.isArray(json.verses)
                ? json.verses
                : [];

    if (!items.length) {
        console.error("Could not find an array of items in thirukkural.json under 'kurals' or 'verses'.");
        process.exit(1);
    }

    const verses = items
        .map(normalizeVerse)
        .filter(v => v && v.number && v.kural);

    verses.sort((a, b) => a.number - b.number);

    const tsData = generateDataTs(verses);
    const tsModel = generateModelTs();

    fs.mkdirSync(path.dirname(outDataPath), {recursive: true});

    fs.writeFileSync(outDataPath, tsData, "utf8");
    console.log("Wrote data:", outDataPath, `(${verses.length} verses)`);

    fs.writeFileSync(outModelPath, tsModel, "utf8");
    console.log("Wrote model:", outModelPath);
}

if (require.main === module) {
    try {
        main();
    } catch (err) {
        console.error("Generation failed:", err);
        process.exit(1);
    }
}
